<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>≈†tefanov Chat üü¢</title>
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/733/733585.png">
    <style>
        :root {
            --primary: #0084ff;
            --bg-chat: #f0f2f5;
            --my-msg: #0084ff;
            --other-msg: #ffffff;
            --text-gray: #65676b;
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            margin: 0; background-color: var(--bg-chat); 
            display: flex; flex-direction: column; height: 100vh; overflow: hidden;
        }

        /* Modern√° Modr√° Hlaviƒçka */
        .hlavicka { 
            background: linear-gradient(90deg, #0084ff, #00c6ff);
            color: white; padding: 15px; text-align: center; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.15); z-index: 100;
        }
        .hlavicka h1 { margin: 0; font-size: 1.2em; letter-spacing: 0.5px; }

        /* Online Zoznam - jemnej≈°√≠ dizajn */
        #online-lista { 
            background: white; padding: 10px; font-size: 0.85em; 
            border-bottom: 1px solid #ddd; color: var(--text-gray); 
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .bodka { height: 8px; width: 8px; background-color: #31a24c; border-radius: 50%; display: inline-block; animation: blikanie 1.5s infinite; }

        /* Chat Okno */
        #chat-okno { 
            flex: 1; padding: 15px; overflow-y: auto; display: flex; 
            flex-direction: column; gap: 12px;
            background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
            background-blend-mode: overlay; background-color: #e5ddd5;
        }

        /* Bubliny Spr√°v */
        .sprava { 
            max-width: 75%; padding: 10px 14px; border-radius: 20px; 
            font-size: 0.95em; position: relative; line-height: 1.4;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .odoslana { 
            background-color: var(--my-msg); align-self: flex-end; color: white; 
            border-bottom-right-radius: 4px;
        }
        .prijata { 
            background-color: var(--other-msg); align-self: flex-start; color: black; 
            border-bottom-left-radius: 4px;
        }
        .autor-mena { font-size: 0.7em; font-weight: bold; margin-bottom: 3px; display: block; opacity: 0.7; }

        /* Panel na p√≠sanie */
        .pisanielista { 
            background-color: white; padding: 12px; display: flex; gap: 10px; 
            align-items: center; border-top: 1px solid #ddd;
        }
        input { 
            flex: 1; padding: 12px 18px; border-radius: 25px; 
            border: 1px solid #ccd0d5; outline: none; font-size: 1em;
        }
        .send-btn { 
            background-color: var(--primary); color: white; border: none; 
            width: 45px; height: 45px; border-radius: 50%; cursor: pointer;
            font-size: 1.2em; display: flex; align-items: center; justify-content: center;
            transition: transform 0.2s;
        }
        .send-btn:active { transform: scale(0.9); }

        /* Tlaƒçidl√° v hlaviƒçke */
        .admin-btns { display: flex; justify-content: center; gap: 10px; padding: 5px; background: #f0f2f5; }
        .btn-small { 
            background: #e4e6eb; border: none; padding: 5px 10px; border-radius: 5px;
            font-size: 0.7em; cursor: pointer; color: #4b4f56; font-weight: bold;
        }
        .btn-small:hover { background: #d8dadf; }
    </style>
</head>
<body>

    <div class="hlavicka">
        <h1>≈†tefanov Messenger üîî</h1>
    </div>

    <div class="admin-btns">
        <button class="btn-small" onclick="vymazatMena()">üßπ Vyƒçisti≈• men√°</button>
        <button class="btn-small" onclick="vymazatVsetko()">üóëÔ∏è Vymaza≈• hist√≥riu</button>
    </div>

    <div id="online-lista">
        <span class="bodka"></span> Online: <span id="zoznam-mien" style="color:#31a24c">prip√°janie...</span>
    </div>
    
    <div id="chat-okno"></div>
    
    <div style="text-align:center; font-size: 0.7em; color: gray; padding: 8px; cursor:pointer;" id="stav-zvuku" onclick="aktivujZvuk()">
        üîà Zvuk je vypnut√Ω. Klikni pre aktiv√°ciu.
    </div>
    
    <div class="pisanielista">
        <input type="text" id="vstup" placeholder="Nap√≠≈° spr√°vu...">
        <button class="send-btn" id="tlacidloPoslat">‚ûî</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, getDocs, deleteDoc, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAdhUJoq7szgFbp8WN5bTKx3Ib6OR8Oh5o",
            authDomain: "stefanov-chat.firebaseapp.com",
            projectId: "stefanov-chat",
            storageBucket: "stefanov-chat.firebasestorage.app",
            messagingSenderId: "915409159507",
            appId: "1:915409159507:web:d4fade5388b7822968cda6"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const spravyRef = collection(db, "spravy");
        const onlineRef = collection(db, "online_uzivatelia");
        const zvuk = new Audio('https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3');

        let menoUzivatela = prompt("Zadaj svoje meno:") || "Hos≈•_" + Math.floor(Math.random() * 1000);
        let prveNacitanie = true;

        // --- PRESENCE SYST√âM ---
        const aktualizujStatus = () => {
            setDoc(doc(db, "online_uzivatelia", menoUzivatela), { meno: menoUzivatela, cas: Date.now() });
        };
        aktualizujStatus();
        setInterval(aktualizujStatus, 30000);

        onSnapshot(onlineRef, (snapshot) => {
            let mena = [];
            const TERAZ = Date.now();
            const LIMIT = 3 * 60 * 1000; 

            snapshot.forEach(d => {
                const data = d.data();
                if (TERAZ - data.cas < LIMIT) {
                    if(!mena.includes(data.meno)) mena.push(data.meno);
                } else {
                    deleteDoc(doc(db, "online_uzivatelia", d.id));
                }
            });
            document.getElementById('zoznam-mien').innerText = mena.join(", ");
        });

        window.onbeforeunload = () => { deleteDoc(doc(db, "online_uzivatelia", menoUzivatela)); };

        // --- FUNKCIE ---
        window.vymazatMena = async function() {
            if (confirm("Vymaza≈• zoznam online ƒæud√≠?")) {
                const snap = await getDocs(onlineRef);
                snap.forEach(d => deleteDoc(doc(db, "online_uzivatelia", d.id)));
            }
        };

        window.aktivujZvuk = function() {
            zvuk.play().then(() => {
                zvuk.pause();
                document.getElementById('stav-zvuku').innerHTML = "üîî Zvuk: <b style='color:green'>AKT√çVNY</b>";
            });
        };

        async function poslatSpravu() {
            const vstup = document.getElementById('vstup');
            if (vstup.value.trim() !== "") {
                const txt = vstup.value;
                vstup.value = "";
                await addDoc(spravyRef, { text: txt, cas: Date.now(), autor: menoUzivatela });
            }
        }

        document.getElementById('tlacidloPoslat').onclick = poslatSpravu;
        document.getElementById('vstup').addEventListener('keypress', (e) => { if (e.key === 'Enter') poslatSpravu(); });

        window.vymazatVsetko = async function() {
            if (confirm("Vymaza≈• cel√∫ hist√≥riu spr√°v?")) {
                const snapshot = await getDocs(spravyRef);
                snapshot.forEach(async (d) => { await deleteDoc(doc(db, "spravy", d.id)); });
            }
        };

        onSnapshot(query(spravyRef, orderBy("cas", "asc")), (snapshot) => {
            const okno = document.getElementById('chat-okno');
            if (!prveNacitanie) {
                snapshot.docChanges().forEach(z => {
                    if (z.type === "added" && z.doc.data().autor !== menoUzivatela) zvuk.play().catch(()=>{});
                });
            }
            okno.innerHTML = ""; 
            snapshot.forEach((doc) => {
                const data = doc.data();
                const div = document.createElement('div');
                const jeMoja = data.autor === menoUzivatela;
                div.classList.add('sprava', jeMoja ? 'odoslana' : 'prijata');
                div.innerHTML = `${jeMoja ? "" : `<span class="autor-mena">${data.autor}</span>`}${data.text}`;
                okno.appendChild(div);
            });
            okno.scrollTop = okno.scrollHeight;
            prveNacitanie = false;
        });
    </script>
</body>
</html>
