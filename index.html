<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>≈†tefanov Messenger üü¢</title>
    <style>
        :root { --primary: #0084ff; --bg-chat: #f0f2f5; --my-msg: #0084ff; --other-msg: #ffffff; }
        body { font-family: -apple-system, sans-serif; margin: 0; background-color: var(--bg-chat); display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .hlavicka { background: linear-gradient(90deg, #0084ff, #00c6ff); color: white; padding: 15px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .admin-btns { display: flex; justify-content: center; gap: 10px; padding: 5px; background: #f0f2f5; }
        .btn-small { background: #e4e6eb; border: none; padding: 5px 10px; border-radius: 5px; font-size: 0.7em; cursor: pointer; font-weight: bold; }
        #chat-okno { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; background-color: #e5ddd5; }
        .sprava { max-width: 75%; padding: 10px 14px; border-radius: 20px; font-size: 0.95em; box-shadow: 0 1px 2px rgba(0,0,0,0.1); position: relative; }
        .odoslana { background-color: var(--my-msg); align-self: flex-end; color: white; border-bottom-right-radius: 4px; }
        .prijata { background-color: var(--other-msg); align-self: flex-start; color: black; border-bottom-left-radius: 4px; }
        .chat-img { max-width: 100%; border-radius: 10px; margin-top: 5px; display: block; cursor: pointer; }
        .pisanielista { background-color: white; padding: 12px; display: flex; gap: 10px; align-items: center; border-top: 1px solid #ddd; }
        input[type="text"] { flex: 1; padding: 12px 18px; border-radius: 25px; border: 1px solid #ccd0d5; outline: none; }
        .btn-icon { background: none; border: none; font-size: 1.5em; cursor: pointer; }
        #loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.7); z-index: 1000; align-items: center; justify-content: center; font-weight: bold; color: #0084ff; }
    </style>
</head>
<body>
    <div id="loading-overlay">Posielam obr√°zok... ‚è≥</div>
    <div class="hlavicka"><h1>≈†tefanov Messenger üîî</h1></div>
    <div class="admin-btns">
        <button class="btn-small" onclick="vymazatVsetko()">üóëÔ∏è Vymaza≈• hist√≥riu</button>
    </div>
    <div id="chat-okno"></div>
    <div class="pisanielista">
        <input type="file" id="foto-vstup" accept="image/*" style="display: none;" onchange="nahratFoto(this)">
        <button class="btn-icon" onclick="document.getElementById('foto-vstup').click()">üì∑</button>
        <input type="text" id="vstup" placeholder="Nap√≠≈° spr√°vu...">
        <button onclick="poslatSpravu()" style="background:#0084ff; color:white; border:none; border-radius:50%; width:40px; height:40px; cursor:pointer;">‚ûî</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAdhUJoq7szgFbp8WN5bTKx3Ib6OR8Oh5o",
            authDomain: "stefanov-chat.firebaseapp.com",
            projectId: "stefanov-chat",
            storageBucket: "stefanov-chat.firebasestorage.app",
            messagingSenderId: "915409159507",
            appId: "1:915409159507:web:d4fade5388b7822968cda6"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const spravyRef = collection(db, "spravy");

        let menoUzivatela = prompt("Zadaj meno:") || "Hos≈•";

        window.nahratFoto = async function(vstup) {
            const subor = vstup.files[0];
            if (!subor) return;
            document.getElementById('loading-overlay').style.display = 'flex';
            try {
                const storageRef = ref(storage, 'chat_obrazky/' + Date.now() + "_" + subor.name);
                await uploadBytes(storageRef, subor);
                const url = await getDownloadURL(storageRef);
                await addDoc(spravyRef, { image: url, cas: Date.now(), autor: menoUzivatela });
            } catch (e) { 
                alert("Chyba! Mus√≠≈° v konzole aktivova≈• Blaze plan."); 
            }
            document.getElementById('loading-overlay').style.display = 'none';
        };

        window.poslatSpravu = async function() {
            const v = document.getElementById('vstup');
            if (v.value.trim() !== "") {
                await addDoc(spravyRef, { text: v.value, cas: Date.now(), autor: menoUzivatela });
                v.value = "";
            }
        };

        onSnapshot(query(spravyRef, orderBy("cas", "asc")), (snapshot) => {
            const okno = document.getElementById('chat-okno');
            okno.innerHTML = "";
            snapshot.forEach((doc) => {
                const data = doc.data();
                const div = document.createElement('div');
                div.classList.add('sprava', data.autor === menoUzivatela ? 'odoslana' : 'prijata');
                div.innerHTML = data.image ? `<img src="${data.image}" class="chat-img" onclick="window.open('${data.image}')">` : data.text;
                okno.appendChild(div);
            });
            okno.scrollTop = okno.scrollHeight;
        });

        window.vymazatVsetko = async () => { if(confirm("Zmaza≈• hist√≥riu?")) { (await getDocs(spravyRef)).forEach(d => deleteDoc(doc(db, "spravy", d.id))); } };
    </script>
</body>
</html>
